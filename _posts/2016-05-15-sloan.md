---
layout: post
title:  "Fraud Measurement in R: Sloan F-Scores"
date:   2016-05-15
author: Jason Weinreb
---
This post gives some R code to compute companies' Sloan Scores, which measure the likelihood that firms have committed accounting fraud. The original paper by Sloan et al is <a href = "http://faculty.washington.edu/geweili/papers/DGLSpublished.pdf">here</a>

Say we're interested in the Sloan Scores of some group of firms, each of which is publicly traded. We can import financial data about these companies from Bloomberg directly into R using the handy <a href = "https://cran.r-project.org/package=Rblpapi">Rblpapi package</a>, which is more robust than other packages I've used (like Rbbg). We can wrap all of the code into one `GetInputs` function, below. For each stock in a  vector **secs** we'll need to import a bunch of Bloomberg fields (**flds**) giving various pieces financial information. To calculate annual values of our inputs, we need to sum over four quarters of data in each of the last two years -- this is what we accomplish with the 'for' loop. Finally, we want to make sure that firms without preferred stock have 0 values for this field instead of missing, which will unnecessarily drop firms from our sample later on. 

<!--more-->

{% highlight r %}
library(TTR)
library(Rblpapi)
blpConnect()

GetInputs <- function(secs){

  flds <- c("SALES_REV_TURN",                    # "Sales"
            "BS_CUR_ASSET_REPORT",               # Curr Assets
            "CASH_&_ST_INVESTMENTS",             # cash and short-term investment
            "BS_CUR_LIAB",                       # current liabilities
            "SHORT_AND_LONG_TERM_DEBT",          # total debt
            "BS_TOT_ASSET",                      # total assets
            "BS_TOT_INVEST_ASSET",               # investments
            "BS_TOT_LIAB2",                      # total liabilities
            "BS_LT_BORROW",                      # short-term debt
            "BS_ST_BORROW",                      # long-term debt
            "BS_LT_INVEST",                      # long-term investment
            "BS_MKT_SEC_OTHER_ST_INVEST",        # short-term investment
            "ARD_ISSUANCE_OF_PREFERRED_STK",     # preferred stock
            "BS_ACCTS_REC_EXCL_NOTES_REC",     	 # accounts receivable
            "BS_INVENTORIES",                    # inventory
            "BS_NET_FIX_ASSET",                  # PP&E
            "BS_CASH_NEAR_CASH_ITEM",            # cash and cash equivs.
            "NET_INCOME")                        # earnings

  res <- data.frame()
  for(sec in secs){
    p <- bdh(sec, fields = flds, start.date = as.Date("2014-3-30"), end.date = as.Date("2016-01-01"))
    sales <- c(sum(p$SALES_REV_TURN[1:4]), sum(p$SALES_REV_TURN[5:8])) # sum four quarters of sales
    earnings <- c(sum(p$NET_INCOME[1:4]), sum(p$NET_INCOME[5:8])) # sum four quarters of earnings
    p <- p[c(4, 8), ] # pull two most recent year-end filings
    p$NET_INCOME <- earnings
    p$SALES_REV_TURN <- sales
    p$ARD_ISSUANCE_OF_PREFERRED_STK[is.na(p$ARD_ISSUANCE_OF_PREFERRED_STK)] <- 0
    p <- merge(data.frame(sec = sec), p)
    res <- rbind(res, p)
  }

  names(res) <- c("sec", "date", "sales", "cur.asset", "cash.and.st.invest", "cur.liab",
                  "tot.debt", "tot.asset", "tot.invest", "tot.liab", "lt.debt",
                  "st.debt", "lt.invest", "st.invest", "pref.stk", "accts.rec",
                  "inventory", "net.fixed.asset", "cash", "earnings")

  return(res)

}


{% endhighlight %}

I used the code to get data about a subset of firms and exported the result to [sloan_web.csv](/assets/sloan_web.csv), which we'll use for the rest of the analysis. The data are shown below, and variable names are fairly self-explanatory. Note that prefixes "st" and "lt" stand for short- and long-term, respectively, with variables like **cur.liab** meaning current liabilities. 
{% highlight r %}
p <- read.csv("sloan_web.csv", header = T)
head(p)
     sec           date    sales   cur.asset cash.and.st.invest cur.liab tot.debt tot.asset tot.invest  tot.liab   lt.debt  st.debt lt.invest
1  CQP US Equity 12/31/14 268.698   486.520            248.830  214.756  8991.333 10387.515      0.000  9256.786  8991.333    0.000     0.000
2  CQP US Equity 12/31/15 270.028   493.475            146.221 2065.835 11854.878 12996.327      0.000 12283.396 10178.681 1676.197     0.000
3 PEGI US Equity 12/31/14 265.493   197.088            101.656  250.199  1463.858  2795.287      0.000  1630.553  1304.165  159.693     0.000
4 PEGI US Equity 12/31/15 320.021   203.329             94.808  520.687  1770.886  3829.592      0.000  2053.830  1371.742  399.144     0.000
5  KOS US Equity 12/31/14 856.584  1010.476            554.831  448.771   794.269  2972.766     14.174  1633.807   794.269    0.000    14.174
6  KOS US Equity 12/31/15 488.346   734.148            275.004  456.741   860.878  3203.050     37.687  1877.537   860.878    0.000    37.687
    st.invest pref.stk accts.rec inventory net.fixed.asset  cash   earnings
1         0        0     0.310     4.293        8978.356   248.830 -410.036
2         0        0     0.742    16.667       11931.602   146.221 -318.891
3         0        0    35.759     0.000        2377.051   101.656  -31.290
4         0        0    45.292     0.000        3294.620   94.808  -32.533
5         0        0   122.323    55.354        1784.846   554.831  279.370
6         0        0   103.150    85.173        2322.839   275.004  -69.836
{% endhighlight %}
Next, we can calculate the Sloan Score for each firm given by:

$$ y = -7.893 + 0.790(\text{RST Accruals}) + 2.518(\Delta \text{Receivables}) + 1.191(\Delta\text{Inventory}) +\\ 1.979(\%\text{Soft Assets}) + 0.171(\Delta\text{Cash Sales}) - 0.932(\Delta\text{ROA}) + 1.029(\text{Debt Issuance}) $$

(For those following the original paper, this is the regression from Model 1.)

Since Sloan scores are calculated with a logistic regression, the conditional probability of having committed accounting fraud is then just:

$$ p = \frac{e^{y}}{1 + e^{y}} $$

One problem here is that values of $$p$$ tend to be very low -- on the order of half of one percent. Why? The incidence of documented frauds in Sloan's original sample was extremely small, as it necessarily included only companies that had been *caught* cooking the books. Presumably, some firms that got away with fraud were never caught. So, to make our estimates more useful in comparing firms to each other, we can do a normalization. Take the raw Sloan scores -- the conditional probability of fraud -- and divide them by the *unconditional* probability of having committed fraud, which Sloan originally found was 0.37\%. This metric, called the F-score, is just $$ F = p/0.0037$$

Thus, an F-score of $$k$$ means that a given firm is around $$k$$ times more likely to have committed fraud than a firm drawn at random from our sample.

The `CalcSignal()` function below calculates the F-scores of firms in our sample data. For each firm in the sample, we isolate its data from the larger data frame, compute the variables used in calculating the Sloan score, and back out the estimated probability of fraud from Sloan's original logit model. Then, we normalize that probability by the unconditional probability of fraud to get the F-scores, rank firms in decreasing order by their F-scores. 

{% highlight r %}

CalcSignal <- function(p){

  p$sec <- as.character(p$sec)
  p$WC <- (p$cur.asset - p$cash.and.st.invest) - (p$cur.liab - p$st.debt)
  p$NCO <- (p$tot.asset - p$cur.asset - p$tot.invest) - (p$tot.liab - p$cur.liab - p$lt.debt)
  p$FIN <- (p$st.invest + p$lt.invest) - (p$lt.debt + p$st.debt)

  # Create placeholder for model matrix containing Sloan Score variables, and logit coefs
  df <- data.frame(sec = unique(p$sec), constant = rep(1, length(unique(p$sec))))
  coefs <- c(-7.893, 0.790, 2.518, 1.191, 1.979, 0.171, -0.932, 1.029)

  # For each firm in the sample:
  for(i in 1:length(unique(p$sec))){

    # Isolate its data
    sub.p <- p[p$sec == unique(p$sec)[i], ]

    # Compute:
    # RSST Accruals
    df$rst_acc[i] <- (diff(sub.p$WC) + diff(sub.p$NCO) + diff(sub.p$FIN)) / mean(sub.p$tot.asset)

    # Change in receivables
    df$ch_rec[i] <- diff(sub.p$accts.rec) / mean(sub.p$tot.asset)

    # Change in inventory
    df$ch_inv[i] <- diff(sub.p$inventory) / mean(sub.p$tot.asset)

    # Soft Assets
    df$soft_assets[i] <- c((sub.p$tot.asset - sub.p$net.fixed.asset - sub.p$cash)/sub.p$tot.asset)[2]

    # Change in Sales
    df$ch_cs[i] <- ROC(sub.p$sales - sub.p$accts.rec, n = 1, type = "discrete")[2]

    # Change in ROA
    df$ch_roa[i] <- diff(sub.p$earnings/sub.p$tot.assets

    # Indicator: did debt increase in the past year?
    df$iss[i] <- ifelse(diff(sub.p$lt.debt) + diff(sub.p$st.debt) > 0, 1, 0)
    y <- sum(coefs*df[i ,2:9])
    df$sloan.prob <- exp(y)/(1 + exp(y))

  }

  df <- df[complete.cases(df), ]
  df$f.score <- df$sloan.prob / 0.0037
  df <- df[order(df$f.score, decreasing = T), ]

  return(df)

}

{% endhighlight %}

Running the code on our sample data gives:

{% highlight r %}
res <- head(CalcSignal(p), 31)[-1,]
head(res)
         sec       constant   rst_acc    ch_rec     ch_inv     soft_assets    ch_cs    ch_roa iss     sloan.prob    f.score
22  EXAS US Equity        1 0.04061023 0.010506262 0.007856805   0.7934894 80.7630332 -0.113350467   1 0.999831824 270.224817
103    Z US Equity        1 1.02634522 0.004584948 0.000000000   0.8983394  1.0094301  0.019643070   1 0.016150476   4.364994
105   ZG US Equity        1 1.02634522 0.004584948 0.000000000   0.8983394  1.0094301  0.019643070   1 0.016150476   4.364994
38  NVRO US Equity        1 0.18497850 0.064462940 0.192732525   0.6811970  0.8135038 -0.080066854   1 0.008457699   2.285865
16   OPK US Equity        1 0.51501864 0.085514686 0.011347638   0.8837711  3.1860560  0.124693400   0 0.006183243   1.671147
15  BMRN US Equity        1 0.39502852 0.006603654 0.023282496   0.7047095  0.1972815  0.008054083   1 0.006140308   1.659543
{% endhighlight %}

We can then plot the firms with the highest Sloan Scores and consider shorting them,
given their high likelihood of having fraudulent books. For presentation purposes, we exclude life sciences company EXAS US Equity (Exact Sciences). We'll be particularly interested in looking at firms with higher-than-average likelihood of Fraud, with F-scores above 1. 

{% highlight r %}
end_point = 0.5 + nrow(res) + nrow(res)-1
barplot(res$f.score, col="red", main="Sloan Scores for Selected US Equities",
        ylab="Sloan F-Score", ylim=c(0,4.5), xlab = "", space=1, yaxs = "i", yaxt = "n")
axis(2, at = seq(0, 4.5, 0.5), seq(0, 4.5, 0.5), las = 2)
tLabs <- gsub(" Equity", "", res$sec)
text(x = seq(1.5,end_point,by=2), y = par("usr")[3] - 0.2, labels = tLabs, cex = 0.7, srt = 90, pos=1, xpd = T)
text(x = seq(1.5,end_point,by=2), y = res$f.score + 0.1, labels = round(res$f.score, 2), cex = 0.6, srt = 80)
abline(h = 1, lty = 2)
{% endhighlight %}

{% fullwidth 'assets/img/highSloan.png' %}
