<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Computing Risk Neutral Distributions from Option Prices in R</title>
  <meta name="description" content="This post gives some R code to replicate a 2014 paper by Allan Malz, essentially a cookbook for computing risk-neutral distributions from option prices. Thes...">

  <!-- Google Fonts loaded here depending on setting in _data/options.yml true loads font, blank does not-->
  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  
  
  <!-- Load up MathJax script if needed ... specify in /_data/options.yml file-->
  
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

  <link rel="stylesheet" type="text/css" href="/css/tufte.css">
  <!-- <link rel="stylesheet" type="text/css" href="/css/print.css" media="print"> -->

  <link rel="canonical" href="/articles/16/rnds">

  <link rel="alternate" type="application/rss+xml" title="jweinreb.github.io" href="/feed.xml" />
</head>

  <body>
    <!--- Header and nav template site-wide -->
<header>
    <nav class="group">
	<a href="/"><img class="badge" src="/assets/img/SU_New_BlockStree_2color.png" alt="CH"></a>
	
		
  	
		
		    
		      <a href="/">blog</a>
		    
	    
  	
		
		    
		      <a href="/vitae/">Vitae</a>
		    
	    
  	
		
		    
		      <a href="/about/">About</a>
		    
	    
  	
		
		    
		      <a href="/css/print.css"></a>
		    
	    
  	
		
  	
	</nav>
</header>

    <article class="group">
      <h1>Computing Risk Neutral Distributions from Option Prices in R</h1>
<p class="subtitle">May 15, 2016</p>

<p>This post gives some R code to replicate a <a href="https://www.newyorkfed.org/medialibrary/media/research/staff_reports/sr677.pdf">2014 paper</a> by Allan Malz, essentially a cookbook for computing risk-neutral distributions from option prices. These distributions give us a sense of investors’ expected beliefs about future asset prices (assuming investors are close enough to being risk neutral). The below example relies on <a href="/assets/OptPanel.csv">a panel of option prices on USDBRL</a>.</p>

<!--more-->

<p>Load the requisite libraries and data.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="s2">"openxlsx"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"zoo"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"fOptions"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"pracma"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"lubridate"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"reshape"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"TTR"</span><span class="p">)</span><span class="w">

</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"OptPanel.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="o">$</span><span class="n">dts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">dts</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%Y-%m-%d"</span><span class="p">)</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">zoo</span><span class="p">(</span><span class="n">p</span><span class="p">[,</span><span class="m">2</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">p</span><span class="p">)],</span><span class="w"> </span><span class="n">order.by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">dts</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
            </span><span class="n">rr10</span><span class="w">    </span><span class="n">rr25</span><span class="w">   </span><span class="n">bf10</span><span class="w">  </span><span class="n">bf25</span><span class="w">   </span><span class="n">S</span><span class="w">      </span><span class="nb">F</span><span class="w">      </span><span class="n">r</span><span class="w">      </span><span class="n">q</span><span class="w">
</span><span class="m">2009-11-17</span><span class="w"> </span><span class="m">10.6500</span><span class="w"> </span><span class="m">5.8450</span><span class="w"> </span><span class="m">2.680</span><span class="w"> </span><span class="m">1.000</span><span class="w"> </span><span class="m">1.7117</span><span class="w"> </span><span class="m">1.7224</span><span class="w">  </span><span class="m">3.766</span><span class="w"> </span><span class="m">0.275</span><span class="w">
</span><span class="m">2009-11-18</span><span class="w"> </span><span class="m">10.7600</span><span class="w"> </span><span class="m">5.8225</span><span class="w"> </span><span class="m">2.910</span><span class="w"> </span><span class="m">1.000</span><span class="w"> </span><span class="m">1.7255</span><span class="w"> </span><span class="m">1.7372</span><span class="w"> </span><span class="m">10.768</span><span class="w"> </span><span class="m">0.230</span><span class="w">
</span><span class="m">2009-11-19</span><span class="w"> </span><span class="m">10.2800</span><span class="w"> </span><span class="m">5.6000</span><span class="w"> </span><span class="m">2.825</span><span class="w"> </span><span class="m">0.970</span><span class="w"> </span><span class="m">1.7268</span><span class="w"> </span><span class="m">1.7380</span><span class="w">  </span><span class="m">7.895</span><span class="w"> </span><span class="m">0.275</span><span class="w">
</span><span class="m">2009-11-20</span><span class="w"> </span><span class="m">10.2275</span><span class="w"> </span><span class="m">5.5850</span><span class="w"> </span><span class="m">2.795</span><span class="w"> </span><span class="m">0.970</span><span class="w"> </span><span class="m">1.7314</span><span class="w"> </span><span class="m">1.7422</span><span class="w">  </span><span class="m">4.153</span><span class="w"> </span><span class="m">0.275</span><span class="w">
</span><span class="m">2009-11-23</span><span class="w">  </span><span class="m">9.7900</span><span class="w"> </span><span class="m">5.3800</span><span class="w"> </span><span class="m">2.590</span><span class="w"> </span><span class="m">0.935</span><span class="w"> </span><span class="m">1.7265</span><span class="w"> </span><span class="m">1.7374</span><span class="w">  </span><span class="m">7.211</span><span class="w"> </span><span class="m">0.275</span><span class="w">
</span><span class="m">2009-11-24</span><span class="w">  </span><span class="m">9.7925</span><span class="w"> </span><span class="m">5.3575</span><span class="w"> </span><span class="m">2.660</span><span class="w"> </span><span class="m">0.945</span><span class="w"> </span><span class="m">1.7313</span><span class="w"> </span><span class="m">1.7403</span><span class="w">  </span><span class="m">5.546</span><span class="w"> </span><span class="m">0.275</span></code></pre></figure>

<p>Variables are as follows:</p>

<p><strong>rr10</strong> price of a 90-10 3m risk reversal<br />
<strong>r25</strong> price of a 75-25 3m risk reversal<br />
<strong>bf10</strong> price of a 90-10 3m butterfly<br />
<strong>bf25</strong> price of a 75-25 3m butterfly<br />
<strong>S</strong> USDBRL spot<br />
<strong>F</strong> USDBRL 3m forward<br />
<strong>r</strong> Brazil policy rate<br />
<strong>q</strong> US policy rate\</p>

<p>The first step in computing (more like imputing…) risk-neutral distributions is to use listed option prices to back out implied volatiles at different values of delta. We can wrap this process into a <code class="highlighter-rouge">GetVolatilities()</code> function.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">GetVolatilities</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">p</span><span class="p">){</span><span class="w">
	</span><span class="c1"># Args:
</span><span class="w">	</span><span class="c1"># -----
</span><span class="w">	</span><span class="c1"># Data.frame with variables
</span><span class="w">	</span><span class="c1"># date dts; option prices rr10, rr25, bf10, bf25; interest rates r and q
</span><span class="w">	</span><span class="c1">#
</span><span class="w">	</span><span class="c1"># Returns:
</span><span class="w">	</span><span class="c1"># ---------
</span><span class="w">	</span><span class="c1"># Data.frame with 10, 25, 50, 75, 90 call delta volatilities
</span><span class="w">
	</span><span class="c1">## Back out ATM volatility
</span><span class="w">	</span><span class="n">atm.SS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">atm</span><span class="p">){</span><span class="w">
		</span><span class="n">lhs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.5</span><span class="w">
		</span><span class="n">rhs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GBSGreeks</span><span class="p">(</span><span class="n">Selection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"delta"</span><span class="p">,</span><span class="w"> </span><span class="n">TypeFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"c"</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w">
	                  </span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atm</span><span class="p">)</span><span class="w">
		</span><span class="nf">return</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">lhs</span><span class="o">-</span><span class="n">rhs</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="p">)</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">p</span><span class="p">)){</span><span class="w">
		</span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
		</span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
		</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
		</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
		</span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">100</span><span class="o">*</span><span class="n">optimize</span><span class="p">(</span><span class="n">atm.SS</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="o">$</span><span class="n">minimum</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="c1">## Get volatilities from RR, BF and ATM data:
</span><span class="w">	</span><span class="n">p</span><span class="o">$</span><span class="n">sig25</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">bf25</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="o">*</span><span class="n">p</span><span class="o">$</span><span class="n">rr25</span><span class="w">
	</span><span class="n">p</span><span class="o">$</span><span class="n">sig75</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">bf25</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0.5</span><span class="o">*</span><span class="n">p</span><span class="o">$</span><span class="n">rr25</span><span class="w">
	</span><span class="n">p</span><span class="o">$</span><span class="n">sig10</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">bf10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.5</span><span class="o">*</span><span class="n">p</span><span class="o">$</span><span class="n">rr10</span><span class="w">
	</span><span class="n">p</span><span class="o">$</span><span class="n">sig90</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">$</span><span class="n">bf10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0.5</span><span class="o">*</span><span class="n">p</span><span class="o">$</span><span class="n">rr10</span><span class="w">

	</span><span class="nf">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">

</span><span class="p">}</span><span class="w">

</span><span class="n">head</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
             </span><span class="n">rr10</span><span class="w">   </span><span class="n">rr25</span><span class="w">  </span><span class="n">bf10</span><span class="w">  </span><span class="n">bf25</span><span class="w">    </span><span class="n">S</span><span class="w">      </span><span class="nb">F</span><span class="w">      </span><span class="n">r</span><span class="w">      </span><span class="n">q</span><span class="w">     </span><span class="n">atm</span><span class="w">       </span><span class="n">sig25</span><span class="w">      </span><span class="n">sig75</span><span class="w">    </span><span class="n">sig10</span><span class="w">     </span><span class="n">sig90</span><span class="w">
</span><span class="m">2009-11-17</span><span class="w"> </span><span class="m">10.6500</span><span class="w"> </span><span class="m">5.8450</span><span class="w"> </span><span class="m">2.680</span><span class="w"> </span><span class="m">1.000</span><span class="w"> </span><span class="m">1.7117</span><span class="w"> </span><span class="m">1.7224</span><span class="w">  </span><span class="m">3.766</span><span class="w"> </span><span class="m">0.275</span><span class="w"> </span><span class="m">28.338350</span><span class="w"> </span><span class="m">32.260850</span><span class="w"> </span><span class="m">26.415850</span><span class="w"> </span><span class="m">36.34335</span><span class="w"> </span><span class="m">25.693350</span><span class="w">
</span><span class="m">2009-11-18</span><span class="w"> </span><span class="m">10.7600</span><span class="w"> </span><span class="m">5.8225</span><span class="w"> </span><span class="m">2.910</span><span class="w"> </span><span class="m">1.000</span><span class="w"> </span><span class="m">1.7255</span><span class="w"> </span><span class="m">1.7372</span><span class="w"> </span><span class="m">10.768</span><span class="w"> </span><span class="m">0.230</span><span class="w"> </span><span class="m">22.041991</span><span class="w"> </span><span class="m">25.953241</span><span class="w"> </span><span class="m">20.130741</span><span class="w"> </span><span class="m">30.33199</span><span class="w"> </span><span class="m">19.571991</span><span class="w">
</span><span class="m">2009-11-19</span><span class="w"> </span><span class="m">10.2800</span><span class="w"> </span><span class="m">5.6000</span><span class="w"> </span><span class="m">2.825</span><span class="w"> </span><span class="m">0.970</span><span class="w"> </span><span class="m">1.7268</span><span class="w"> </span><span class="m">1.7380</span><span class="w">  </span><span class="m">7.895</span><span class="w"> </span><span class="m">0.275</span><span class="w">  </span><span class="m">5.353995</span><span class="w">  </span><span class="m">9.123995</span><span class="w">  </span><span class="m">3.523995</span><span class="w"> </span><span class="m">13.31900</span><span class="w">  </span><span class="m">3.038995</span><span class="w">
</span><span class="m">2009-11-20</span><span class="w"> </span><span class="m">10.2275</span><span class="w"> </span><span class="m">5.5850</span><span class="w"> </span><span class="m">2.795</span><span class="w"> </span><span class="m">0.970</span><span class="w"> </span><span class="m">1.7314</span><span class="w"> </span><span class="m">1.7422</span><span class="w">  </span><span class="m">4.153</span><span class="w"> </span><span class="m">0.275</span><span class="w"> </span><span class="m">26.872811</span><span class="w"> </span><span class="m">30.635311</span><span class="w"> </span><span class="m">25.050311</span><span class="w"> </span><span class="m">34.78156</span><span class="w"> </span><span class="m">24.554061</span><span class="w">
</span><span class="m">2009-11-23</span><span class="w">  </span><span class="m">9.7900</span><span class="w"> </span><span class="m">5.3800</span><span class="w"> </span><span class="m">2.590</span><span class="w"> </span><span class="m">0.935</span><span class="w"> </span><span class="m">1.7265</span><span class="w"> </span><span class="m">1.7374</span><span class="w">  </span><span class="m">7.211</span><span class="w"> </span><span class="m">0.275</span><span class="w"> </span><span class="m">11.200694</span><span class="w"> </span><span class="m">14.825694</span><span class="w">  </span><span class="m">9.445694</span><span class="w"> </span><span class="m">18.68569</span><span class="w">  </span><span class="m">8.895694</span><span class="w">
</span><span class="m">2009-11-24</span><span class="w">  </span><span class="m">9.7925</span><span class="w"> </span><span class="m">5.3575</span><span class="w"> </span><span class="m">2.660</span><span class="w"> </span><span class="m">0.945</span><span class="w"> </span><span class="m">1.7313</span><span class="w"> </span><span class="m">1.7403</span><span class="w">  </span><span class="m">5.546</span><span class="w"> </span><span class="m">0.275</span><span class="w"> </span><span class="m">13.892116</span><span class="w"> </span><span class="m">17.515866</span><span class="w"> </span><span class="m">12.158366</span><span class="w"> </span><span class="m">21.44837</span><span class="w"> </span><span class="m">11.655866</span></code></pre></figure>

<p>We can then interpolate a cubic spline through these (delta, ivol) pairs using a function <code class="highlighter-rouge">DeltaSmile()</code> and plot the smile using <code class="highlighter-rouge">PlotDeltaSmile()</code>:</p>

<p><label for="ds" class="margin-toggle">⊕</label><input type="checkbox" id="ds" class="margin-toggle" /><span class="marginnote"><img class="fullwidth" src="/assets/deltaSmile.png" /><br />The volatility smile in delta-vol space</span></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">DeltaSmile</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="c1"># Args:
</span><span class="w">	</span><span class="c1"># -----
</span><span class="w">	</span><span class="c1"># date dts, delta input value
</span><span class="w">	</span><span class="c1">#
</span><span class="w">	</span><span class="c1"># Returns:
</span><span class="w">	</span><span class="c1"># --------
</span><span class="w">	</span><span class="c1"># value of interpolated implied vol for given delta
</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span><span class="w">
	</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">sig10</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">sig25</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w">
	       </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">sig75</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">sig90</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="w">
	</span><span class="n">cubicspline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">endp2nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">

	</span><span class="k">if</span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">0.1</span><span class="p">){</span><span class="w">
		</span><span class="n">vol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cubicspline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">endp2nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.9</span><span class="p">){</span><span class="w">
		</span><span class="n">vol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cubicspline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">endp2nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.9</span><span class="p">){</span><span class="w">
		</span><span class="n">vol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cubicspline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">endp2nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">der</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
		</span><span class="p">}</span><span class="w">		
	</span><span class="nf">return</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span><span class="w">

</span><span class="p">}</span><span class="w">

</span><span class="n">PlotDeltaSmile</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">)</span><span class="w">
	</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w">
	</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Call δ"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Implied Volatility"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkblue"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">dtStart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="c1"># set date to 17 November 2009
</span><span class="n">PlotDeltaSmile</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span></code></pre></figure>

<p>Now we transform the volatility smile from delta-ivol space to X-ivol space, where X is the option’s (call) price. We can plot this new volatility smile as a function of X using
the <code class="highlighter-rouge">PlotXSmile()</code> function:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">XSmile</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">){</span><span class="w">

	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">X.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">z</span><span class="w">

	</span><span class="n">sigma.SS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">sigma</span><span class="p">){</span><span class="w">
		</span><span class="n">call.delta</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GBSGreeks</span><span class="p">(</span><span class="n">Selection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"delta"</span><span class="p">,</span><span class="w"> </span><span class="n">TypeFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"c"</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S.</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X.</span><span class="p">,</span><span class="w">
	                    </span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r.</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q.</span><span class="p">)</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigma</span><span class="o">/</span><span class="m">100</span><span class="p">)</span><span class="w">
		</span><span class="n">sigma.hat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call.delta</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="m">100</span><span class="w">                    
		</span><span class="nf">return</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">sigma.hat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sigma</span><span class="o">/</span><span class="m">100</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="p">)</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">optimize</span><span class="p">(</span><span class="n">sigma.SS</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="n">p</span><span class="o">$</span><span class="n">atm</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">$</span><span class="n">minimum</span><span class="w">
	</span><span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w">

</span><span class="p">}</span><span class="w">

</span><span class="n">GetXValues</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">){</span><span class="w">

	</span><span class="n">sigma</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DeltaSmile</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">x.SS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">X.</span><span class="p">){</span><span class="w">
		</span><span class="n">call.delta</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GBSGreeks</span><span class="p">(</span><span class="n">Selection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"delta"</span><span class="p">,</span><span class="w"> </span><span class="n">TypeFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"c"</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S.</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X.</span><span class="p">,</span><span class="w">
	                    </span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r.</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q.</span><span class="p">)</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigma</span><span class="o">/</span><span class="m">100</span><span class="p">)</span><span class="w">
	    </span><span class="nf">return</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">call.delta</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="p">)</span><span class="w">                
	 </span><span class="p">}</span><span class="w">
	</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">optimize</span><span class="p">(</span><span class="n">x.SS</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="n">K.</span><span class="p">))</span><span class="o">$</span><span class="n">minimum</span><span class="w">
	</span><span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">GetRange</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
	</span><span class="n">vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w">
				</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">)</span><span class="w">
	</span><span class="n">res</span><span class="o">$</span><span class="n">min</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="m">-0.05</span><span class="p">,</span><span class="w"> </span><span class="m">-0.125</span><span class="p">)</span><span class="w">
	</span><span class="n">res</span><span class="o">$</span><span class="n">max</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="m">+0.05</span><span class="p">,</span><span class="w"> </span><span class="m">0.125</span><span class="p">)</span><span class="w">
	</span><span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">PlotXSmile</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">

	</span><span class="n">xmin</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">min</span><span class="w">
	</span><span class="n">xmax</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">max</span><span class="w">
	</span><span class="n">xxx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">((</span><span class="n">xmin</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w">
	</span><span class="n">sss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="w"> </span><span class="n">XSmile</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w">

	</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="o">/</span><span class="n">K.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">sss</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">sss</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">sss</span><span class="p">)),</span><span class="w">
			</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"palevioletred"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Implied Volatility"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Moneyness"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XSmile</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"palevioletred"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XSmile</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"palevioletred"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XSmile</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"palevioletred"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XSmile</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"palevioletred"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XSmile</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.90</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"palevioletred"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">PlotXSmile</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span></code></pre></figure>

<figure class="fullwidth"><img src="/assets/xsmile.png" /><figcaption></figcaption></figure>

<p>Now we translate the volatility smile into the call price function for the option via the <code class="highlighter-rouge">Premium()</code> function, and plot the option price using the <code class="highlighter-rouge">PlotPremiums()</code> function:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">Premium</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">){</span><span class="w">

	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">

	</span><span class="n">Premium</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GBSCharacteristics</span><span class="p">(</span><span class="n">TypeFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"c"</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S.</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w">
                  </span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r.</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">r.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q.</span><span class="p">)</span><span class="o">/</span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="n">sigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XSmile</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="m">100</span><span class="p">)</span><span class="o">$</span><span class="n">premium</span><span class="w">
	</span><span class="nf">return</span><span class="p">(</span><span class="n">Premium</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="n">PlotPremiums</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">

	</span><span class="n">xmin</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">min</span><span class="w">
	</span><span class="n">xmax</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">max</span><span class="w">
	</span><span class="n">xxx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">((</span><span class="n">xmin</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w">
	</span><span class="n">sss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="w"> </span><span class="n">Premium</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="w">
	</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="o">/</span><span class="n">K.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">sss</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">sss</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">sss</span><span class="p">)),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"purple"</span><span class="p">,</span><span class="w">
		</span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Moneyness"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Call Price"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">Premium</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"purple"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">Premium</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"purple"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">Premium</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"purple"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">Premium</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"purple"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">Premium</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.90</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"purple"</span><span class="p">)</span><span class="w">		
</span><span class="p">}</span><span class="w">

</span><span class="n">PlotPremiums</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span></code></pre></figure>

<figure class="fullwidth"><img src="/assets/premium.png" /><figcaption></figcaption></figure>

<p>Finally, we can use the call pricing function to plot the risk-neutral CDF of the underlying, getting the value of the CDF at each strike price with the <code class="highlighter-rouge">XCDF()</code> function, and plotting the distribution using the <code class="highlighter-rouge">PlotCDF()</code> function:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">XCDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">,</span><span class="w"> </span><span class="n">dX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.005</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">X_plus</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">dX</span><span class="o">*</span><span class="n">K.</span><span class="o">/</span><span class="m">2</span><span class="p">)</span><span class="w">
	</span><span class="n">X_minus</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">dX</span><span class="o">*</span><span class="n">K.</span><span class="o">/</span><span class="m">2</span><span class="p">)</span><span class="w">
	</span><span class="n">cdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">q.</span><span class="o">/</span><span class="m">100</span><span class="o">*</span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dX</span><span class="o">*</span><span class="n">K.</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">Premium</span><span class="p">(</span><span class="n">X_plus</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Premium</span><span class="p">(</span><span class="n">X_minus</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="n">cdf</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">cdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="p">}</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="n">cdf</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">){</span><span class="n">cdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">}</span><span class="w">
	</span><span class="nf">return</span><span class="p">(</span><span class="n">cdf</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="n">PlotCDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">

	</span><span class="n">xmin</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="m">-0.5</span><span class="p">)</span><span class="w">
	</span><span class="n">xmax</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w">
	</span><span class="n">xxx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">((</span><span class="n">xmin</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w">
	</span><span class="n">sss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="w"> </span><span class="n">XCDF</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w">
	</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="o">/</span><span class="n">K.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">sss</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
		</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Moneyness"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XCDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XCDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XCDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XCDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen"</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XCDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.90</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">PlotCDF</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span></code></pre></figure>

<figure class="fullwidth"><img src="/assets/rndcdf.png" /><figcaption></figcaption></figure>

<p>We can also build similar functions to back out and plot the values of the risk-neutral PDF:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">XPDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">,</span><span class="w"> </span><span class="n">dX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.005</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">X_plus</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dX</span><span class="o">*</span><span class="n">K.</span><span class="w">
	</span><span class="n">X_minus</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dX</span><span class="o">*</span><span class="n">K.</span><span class="w">
	</span><span class="n">pdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">100</span><span class="o">*</span><span class="n">q.</span><span class="o">*</span><span class="m">1</span><span class="o">/</span><span class="m">12</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dX</span><span class="o">*</span><span class="n">K.</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Premium</span><span class="p">(</span><span class="n">X_plus</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
			</span><span class="n">Premium</span><span class="p">(</span><span class="n">X_minus</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="n">Premium</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">))</span><span class="w">
	</span><span class="nf">return</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="n">PlotPDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">dtStart</span><span class="p">){</span><span class="w">
	</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">dtStart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">stop</span><span class="p">(</span><span class="s2">"Date not in data.frame"</span><span class="p">)}</span><span class="w">
	</span><span class="n">S.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">r.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">q.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
	</span><span class="n">K.</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="nb">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">

	</span><span class="n">xmin</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="m">-0.5</span><span class="p">)</span><span class="w">
	</span><span class="n">xmax</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">GetRange</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span><span class="o">$</span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w">
	</span><span class="n">xxx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">((</span><span class="n">xmin</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">xmax</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">K.</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">)</span><span class="w">
	</span><span class="n">sss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="w"> </span><span class="n">XPDF</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="w">
	</span><span class="n">plot</span><span class="p">(</span><span class="n">xxx</span><span class="o">/</span><span class="n">K.</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">sss</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">sss</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">sss</span><span class="p">)),</span><span class="w">
		</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"deepskyblue3"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Moneyness"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XPDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XPDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XPDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XPDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w">
	</span><span class="n">points</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.9</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">)</span><span class="o">/</span><span class="n">K.</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">XPDF</span><span class="p">(</span><span class="n">GetXValues</span><span class="p">(</span><span class="m">0.90</span><span class="p">,</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">dtStart</span><span class="p">),</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">



</span><span class="n">PlotPDF</span><span class="p">(</span><span class="n">dtStart</span><span class="p">)</span></code></pre></figure>

<figure class="fullwidth"><img src="/assets/rndpdf.png" /><figcaption></figcaption></figure>



    </article>
    <span class="print-footer">Computing Risk Neutral Distributions from Option Prices in R - May 15, 2016 - Jason Weinreb</span>
    <footer>
  <hr class="slender">
  <ul class="footer-links">
    <li><a href="mailto:jweinreb@stanford.edu"><span class="icon-mail"></span></a></li>    
    
      <li>
        <a href="//github.com/jweinreb"><span class="icon-github"></span></a>
      </li>
      
    <li><a href="http://linkedin.com/"><i class="fa fa-linkedin"></i></a></li>
  </ul>
<div class="credits">
<span>&copy; 2017 &nbsp;&nbsp;JASON WEINREB</span></br> <br>
<span>This site created with the <a href="//github.com/clayh53/tufte-jekyll">Tufte theme for  </a> in <a href="//jekyllrb.com">Jekyll</a>.</span> 
</div>  
</footer>
  </body>
</html>
